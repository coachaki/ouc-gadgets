<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <!-- This title is not used. -->
    <title>Delete Files</title> 
    
    <style type="text/css">
    body {
        margin: 10px;
        background-color: transparent;
    }
</style>

<!-- jQuery IS REQUIRED for gadgetlib.js to work. -->
<script type="text/javascript" src="../lib/jquery-3.3.1.min.js"></script>

    <!-- 
        gadgetlib.js is a library of basic functions that gadgets can use. It creates a global
        `gadget` object that has a few useful methods. (See comments in gadgetlib.js.)
    -->
    <script type="text/javascript" src="../lib/gadgetlib.min.js"></script>
    
</head>
<body>
    <div id="main">
        <form id="file-form">
            <input name="path" id="path" type="text" style="width:100%"/>
            <input type="button" name="list" value="List Files" disabled/>
            <input type="button" name="delete" value="Delete Files" disabled/>
        </form>
        <div id="file-list">
        </div>
    </div>
    <script type="text/javascript">
        $(document).ready(function () {
            $('input[disabled]').prop('disabled', false);

            let allFiles = [];
            let deletedFiles = [];
            let failedFiles = [];
            $('input[name="list"]').on('click', function(e) {
                let path = $(this).closest('form').find('input[name="path"]')[0].value;
                $.when(getFiles(path)).then(function(files){
                    allFiles = files;

                    let html = '<ul>';
                    allFiles.forEach(function(file){
                        html += '<li>' + file + '</li>';
                    });
                    html += '</ul>';

                    $('#file-list').html(html);
                });
            })
            $('input[name="delete"]').on('click', function(e) {
                deleteFiles(allFiles);
            });

            gadget.ready().then(gadget.fetch).then(function () {
                $('input[disabled]').prop('disabled', false);
            });

            $(gadget).on({
                'expanded': function (evt) {
                    // This event is triggered when the user expands (makes visible) a sidebar gadget.
                    console.log('Gadget expanded.');
                },
                'collapsed': function (evt) {
                    // This event is triggered when the user collapses (hides) a sidebar gadget.
                    console.log('Gadget collapsed.');
                },
                'configuration': function (evt, config) {
                    // If the user changes the gadget's configuration through the configuration modal,
                    // the gadget will hear about it and get the new config in the data argument here.
                    console.log('New config:', config);
                    $('#main').css({ 'font-size': config.font_size });
                },
                'notification': function (evt, notification) {
                    // If the gadget's config.xml contains a "notification" entry, any notifications
                    // of the specified type(s) generated by OU Campus will trigger 'notification'
                    // events that can be handled here.
                    console.log('Notification received:', notification);
                }
            });
        });

        function getFiles(dir) {
            let def = $.Deferred();
            let allFiles = [];

            let params = {
                site: gadget.site,
                authorization_token: gadget.token,
                path: dir
            }
            let url = gadget.apihost + '/files/list';

            $.ajax({
                method: 'get',
                url: url,
                data: params
            })
            .done(function(response){
                // console.log('ls ' + dir, response.entries);
                let defs = [];

                response.entries.forEach(function(entry) {
                    if (entry.is_directory) {
                        defs.push(getFiles(entry.staging_path));
                    } else {
                        allFiles.push(entry.staging_path);
                    }
                });

                $.when.apply($, defs).then(function() {
                    for (let i = 0; i < arguments.length; i++) {
                        allFiles = allFiles.concat(arguments[i]);
                        // console.log('loop ' + i, allFiles);
                    }
                    def.resolve(allFiles);
                });
            });

            // console.log('running ls on ' + dir);
            return def.promise();
        }

        function deleteFiles(fileList) {
            fileList.forEach(function(file) {
                let params = {
                    site: gadget.site,
                    authorization_token: gadget.token,
                    path: file
                }
                let url = gadget.apihost + '/files/delete';

                $.ajax({
                    method: 'post',
                    url: url,
                    data: params
                })
                .done(function(response){
                    console.log(file, response);
                });
            });
        }
    </script>
</body>
</html>
